<link rel="import" href="../../bower_components/polymer/polymer.html">


<!--

The `nfcmin-chat` provides  

@group nfcmin-chat Elements
@element nfcmin-chat
@demo demo/index.html
-->

<dom-module id="nfcmin-chat">

    <style>
        :host {
            display: block;
        }
    </style>
    <template>
        <h1 on-tap="startDiscovery">Chat</h1>
        <template is="dom-repeat" items="" as="device">
            <div>
                <span>[[device.name]]</span>
                <span>[[device.address]]</span>
            </div>


        </template>

    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'nfcmin-chat',

            properties: {
                deviceName: {
                    type: Object,
                    notify: true,
                    value: function () {
                        return {};
                    }
                }
            },
            _addDevice: function (device) {
                this.deviceName[device.address] = device.name;
                this.notifyPath('deviceName.'+device.address, device.name);
                console.log('Add' , device.address,  device.name);
            },
            _removeDevice: function (device) {
                delete this.deviceName[device.address];
                this.notifyPath('deviceName.'+device.address, undefined);
            },
            /**
             * Bluetooth Doc : https://developer.chrome.com/apps/app_bluetooth
             */
            startDiscovery: function () {
                var that = this;
                console.log('list device ', chrome);
                chrome.bluetooth.getAdapterState(function (adapter) {
                    console.log("Adapter " + adapter.address + ": " + adapter.name);
                });
                // Add listeners to receive newly found devices and updates
               // to the previously known devices.
                var addDevice = this._addDevice.bind(this);
                chrome.bluetooth.onDeviceAdded.addListener(addDevice);
                chrome.bluetooth.onDeviceChanged.addListener(addDevice);
                chrome.bluetooth.onDeviceRemoved.addListener(this._removeDevice.bind(this));

                // With the listeners in place, get the list of devices found in
                // previous discovery sessions, or any currently active ones,
                // along with paired devices.
                chrome.bluetooth.getDevices(function (devices) {
                    for (var i = 0; i < devices.length; i++) {
                        that._addDevice(devices[i]);
                    }
                });
                // Now begin the discovery process.
                chrome.bluetooth.startDiscovery(function () {
                    // Stop discovery after 30 seconds.
                    setTimeout(function () {
                        chrome.bluetooth.stopDiscovery(function () {
                        });
                    }, 30000);
                });
            }


        });
    })();
</script>